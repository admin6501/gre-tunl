<div align="center">

# 🚀 GRE TUNL

### مدیریت پیشرفته تونل GRE با HAProxy

[![Bash](https://img.shields.io/badge/Bash-5.0+-green.svg)](https://www.gnu.org/software/bash/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Linux-orange.svg)](https://www.linux.org/)

```
╔═════════════════════════════════════════════════════╗
║                                                     ║
║    ██████╗ ██████╗ ███████╗    ████████╗██╗   ██╗   ║
║   ██╔════╝ ██╔══██╗██╔════╝    ╚══██╔══╝██║   ██║   ║
║   ██║  ███╗██████╔╝█████╗         ██║   ██║   ██║   ║
║   ██║   ██║██╔══██╗██╔══╝         ██║   ██║   ██║   ║
║   ╚██████╔╝██║  ██║███████╗       ██║   ╚██████╔╝   ║
║    ╚═════╝ ╚═╝  ╚═╝╚══════╝       ╚═╝    ╚═════╝    ║
║                                                     ║
║              GRE TUNL - Tunnel Manager              ║
║                                                     ║
╚═════════════════════════════════════════════════════╝
```

</div>

---

## 📖 درباره پروژه

**GRE TUNL** یک ابزار قدرتمند و کاربرپسند برای مدیریت تونل‌های GRE با قابلیت فوروارد پورت توسط HAProxy است. این اسکریپت به شما امکان می‌دهد به راحتی تونل‌های امن بین سرور ایران و خارج راه‌اندازی کنید.

---

## ✨ قابلیت‌ها

### 🔧 مدیریت تونل
- ✅ راه‌اندازی آسان تونل GRE در سرور ایران و خارج
- ✅ پشتیبانی از چندین تونل همزمان
- ✅ مدیریت سرویس‌ها (Start/Stop/Restart)
- ✅ حذف و پاکسازی کامل تونل‌ها

### 🔌 مدیریت پورت
- ✅ افزودن پورت به تونل موجود
- ✅ حذف پورت از تونل
- ✅ پشتیبانی از رنج پورت (مثال: `2050-2060`)
- ✅ پشتیبانی از چند پورت (مثال: `80,443,8080`)

### 📊 مدیریت ترافیک
- ✅ تعیین محدودیت ترافیک برای کل تونل
- ✅ تعیین محدودیت ترافیک برای پورت خاص
- ✅ انتخاب نوع محاسبه (دانلود / آپلود / هردو)
- ✅ نمایش مصرف ترافیک با نوار پیشرفت
- ✅ ریست شمارنده ترافیک
- ✅ توقف خودکار تونل/پورت پس از اتمام حجم

---

## 📋 پیش‌نیازها

- سیستم‌عامل: **Ubuntu 18.04+** / **Debian 10+**
- دسترسی: **Root**
- بسته‌های مورد نیاز: `iproute2`, `haproxy` (خودکار نصب می‌شوند)

---

## 🚀 نصب و راه‌اندازی

### نصب با یک دستور

```bash
sudo bash <(curl -fsSL https://raw.githubusercontent.com/admin6501/gre-tunl/main/gre-tunl.sh)
```

### کلون ریپازیتوری

```bash
git clone https://github.com/admin6501/gre-tunl.git
cd gre-tunl
sudo bash gre-tunl.sh
```

---

## 📚 راهنمای استفاده

### 🏠 منوی اصلی

```
1 > IRAN Setup           # راه‌اندازی تونل در سرور ایران
2 > KHAREJ Setup         # راه‌اندازی تونل در سرور خارج
3 > Services Management  # مدیریت سرویس‌ها
4 > Uninstall & Clean    # حذف و پاکسازی
5 > Add Tunnel Port      # افزودن پورت جدید
6 > Remove Tunnel Port   # حذف پورت
7 > Traffic Limit        # مدیریت محدودیت ترافیک
0 > Exit                 # خروج
```

---

### 🇮🇷 راه‌اندازی سرور ایران

۱. گزینه `1` را انتخاب کنید
۲. اطلاعات زیر را وارد کنید:

| فیلد | توضیح | مثال |
|------|-------|------|
| GRE Number | شماره یکتای تونل | `1` |
| IRAN IP | آی‌پی سرور ایران | `1.2.3.4` |
| KHAREJ IP | آی‌پی سرور خارج | `5.6.7.8` |
| GRE IP Range | رنج آی‌پی داخلی تونل | `10.80.70.0` |
| Ports | پورت‌های فوروارد | `443,8080` |

---

### 🌍 راه‌اندازی سرور خارج

۱. گزینه `2` را انتخاب کنید
۲. اطلاعات را **دقیقاً مشابه سرور ایران** وارد کنید

> ⚠️ **مهم:** شماره GRE و رنج آی‌پی باید در هر دو سرور یکسان باشد!

---

### 📊 مدیریت ترافیک

منوی `Traffic Limit`:

```
1) Set Traffic Limit      # تعیین محدودیت جدید
2) Edit Traffic Limit     # ویرایش محدودیت
3) View Traffic Usage     # نمایش مصرف
4) Reset Traffic Counter  # ریست شمارنده
5) Set Unlimited          # نامحدود کردن
6) Enable Limit           # فعال‌سازی مجدد
7) Remove Limit Config    # حذف کانفیگ
0) Back                   # بازگشت
```

#### انواع محدودیت

| نوع | توضیح | عملکرد پس از اتمام |
|-----|-------|-------------------|
| **کل تونل** | محدودیت روی تمام ترافیک | تونل **STOP** می‌شود |
| **پورت خاص** | محدودیت روی یک پورت | پورت **BLOCK** می‌شود |

#### نوع محاسبه ترافیک

```
1) Download Only (RX)        # فقط دانلود
2) Upload Only (TX)          # فقط آپلود  
3) Download + Upload (RX+TX) # مجموع دانلود و آپلود
```

---

### 📈 نمونه نمایش مصرف

```
┌─────────────────────────────────────────────────────────────────────┐
│                       TRAFFIC USAGE REPORT                         │
├─────────────────────────────────────────────────────────────────────┤
│ GRE1 [UP]  Limit: ON                                                │
│   Total RX (Download): 15.25 GB                                     │
│   Total TX (Upload): 8.80 GB                                        │
│   Mode: Download + Upload (RX+TX)                                   │
│   Used: 10.05 GB / 50.00 GB (20.1%)                                │
│   [████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]                        │
│   ├─ Port 443: Limit ON                                             │
│   │  Used: 5.20 GB / 10.00 GB (52.0%)                              │
│   │  [███████████████░░░░░░░░░░░░░░░]                               │
│   ├─ Port 8080: Limit ON                                            │
│   │  Used: 2.10 GB / 5.00 GB (42.0%)                               │
│   │  [████████████░░░░░░░░░░░░░░░░░░]                               │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📁 ساختار فایل‌ها

```
/etc/
├── systemd/system/
│   └── gre1.service              # سرویس تونل GRE
├── haproxy/
│   ├── haproxy.cfg               # کانفیگ اصلی HAProxy
│   └── conf.d/
│       └── haproxy-gre1.cfg      # کانفیگ پورت‌های تونل
└── gre-limits/
    ├── gre1.conf                 # تنظیمات محدودیت تونل
    ├── gre1_port443.conf         # تنظیمات محدودیت پورت
    └── limit.log                 # لاگ رویدادها

/usr/local/bin/
└── gre-limit-checker.sh          # اسکریپت چک محدودیت
```

---

## 🔧 دستورات مفید

### بررسی وضعیت تونل
```bash
# وضعیت سرویس
systemctl status gre1.service

# نمایش اینترفیس
ip addr show gre1

# تست ارتباط
ping 10.80.70.2  # از ایران به خارج
ping 10.80.70.1  # از خارج به ایران
```

### بررسی HAProxy
```bash
# وضعیت سرویس
systemctl status haproxy

# تست کانفیگ
haproxy -c -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/
```

### مشاهده لاگ محدودیت
```bash
cat /etc/gre-limits/limit.log
```

---

## ❓ سوالات متداول

<details>
<summary><b>چرا باید محدودیت ترافیک فقط روی سرور ایران تنظیم شود؟</b></summary>

چون ترافیک در هر دو سر تونل یکسان است. اگر روی هر دو سرور تنظیم کنید، ترافیک دوبار شمرده می‌شود.
</details>

<details>
<summary><b>تفاوت RX و TX چیست؟</b></summary>

| سرور | RX | TX |
|------|----|----|
| ایران | دانلود کاربر | آپلود کاربر |
| خارج | آپلود کاربر | دانلود کاربر |
</details>

<details>
<summary><b>اگر تونل به علت اتمام حجم متوقف شد چه کنم؟</b></summary>

۱. به منوی `Traffic Limit` بروید
۲. گزینه `Reset Traffic Counter` را انتخاب کنید
۳. تونل/پورت مورد نظر را انتخاب کنید
۴. تأیید کنید - شمارنده ریست و تونل/پورت فعال می‌شود
</details>

<details>
<summary><b>چگونه محدودیت را غیرفعال کنم بدون حذف؟</b></summary>

از گزینه `Set Unlimited` استفاده کنید. کانفیگ حفظ می‌شود و می‌توانید بعداً با `Enable Limit` فعال کنید.
</details>

---

## 🛠️ عیب‌یابی

| مشکل | راه‌حل |
|------|--------|
| تونل بالا نمی‌آید | آی‌پی‌ها را بررسی کنید، فایروال را چک کنید |
| پورت کار نمی‌کند | `systemctl restart haproxy` را اجرا کنید |
| ترافیک شمرده نمی‌شود | مطمئن شوید تونل UP است |
| خطای command not found | اسکریپت را آپدیت کنید |

---

## 📝 تغییرات نسخه

### نسخه 2.0.0
- ➕ افزودن سیستم محدودیت ترافیک
- ➕ پشتیبانی از محدودیت پورت خاص
- ➕ انتخاب نوع محاسبه ترافیک
- ➕ نمایش گرافیکی مصرف
- 🔧 بهبود رابط کاربری
- 🐛 رفع باگ‌های گزارش شده

### نسخه 1.0.0
- 🎉 انتشار اولیه
- ➕ راه‌اندازی تونل GRE
- ➕ فوروارد پورت با HAProxy
- ➕ مدیریت سرویس‌ها

---

## 📄 لایسنس

این پروژه تحت لایسنس **MIT** منتشر شده است.

---

## 🤝 مشارکت

از مشارکت شما استقبال می‌کنیم! لطفاً:

1. پروژه را Fork کنید
2. برنچ جدید بسازید (`git checkout -b feature/amazing`)
3. تغییرات را Commit کنید (`git commit -m 'Add amazing feature'`)
4. Push کنید (`git push origin feature/amazing`)
5. Pull Request ایجاد کنید

---

## 📞 پشتیبانی

- 🐛 **گزارش باگ:** [Issues](https://github.com/YOUR_USERNAME/gre-tunl/issues)
- 💬 **سوالات:** [Discussions](https://github.com/YOUR_USERNAME/gre-tunl/discussions)

---

<div align="center">

**ساخته شده با ❤️ برای جامعه فارسی‌زبان**

⭐ اگر این پروژه برایتان مفید بود، ستاره بدهید! ⭐

</div>
